# Upstream containers
upstream api_upstream { server api:4000; }
upstream web_upstream { server web:80; }

server {
  listen 80;
  server_name _;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name _;

  # TODO: replace with Let's Encrypt or your certs
  ssl_certificate     /etc/ssl/certs/selfsigned.crt;
  ssl_certificate_key /etc/ssl/private/selfsigned.key;

  # Security headers
  add_header X-Frame-Options "SAMEORIGIN";
  add_header X-Content-Type-Options "nosniff";
  add_header Referrer-Policy "strict-origin-when-cross-origin";

  # Web app
  location / {
    proxy_pass http://web_upstream;
    proxy_set_header Host $host;
  }

  # API + websockets
  location /api/ {
    proxy_pass http://api_upstream/api/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
  }
}
